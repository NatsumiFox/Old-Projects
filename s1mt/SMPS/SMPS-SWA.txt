
==========
SMPS - SWA
==========

Драйвер SMPS-SWA предоставляет множество дополнительных возможностей в виде самостоятельной надстройки (addon) над обычным SMPS. Надстройка включает расширенный трекер, благодаря которому стала возможной полноценная поддержка портаменто и смещений нот. Надстройка также предоставляет более совершенную систему громостей.

Замечу, что надстройку использует формат заголовка и флаги координации, несколько отличающиеся от стандартного SMPS. Однако драйвер SMPS-SWA сохраняет полную совместимость с песнями формата SMPS, поскольку настройка представлена в виде отдельного модуля, который замещает собой часть ядра оригинального драйвера, и включается, когда драйвер распознает определенный формат заголовка.

----------------
Формат заголовка
----------------

Заголовок песен усоврешенствованного формата, в целом, повторяет стандартный заголовок SMPS 68K за некоторыми исключениями:

- К количеству FM каналов прибавляется $80, чтобы драйвер смог идентифицировать усовершенствованный формат и включить надстройку.
- Громкости FM каналов задаются в другом формате. Для преобразования из формата обычного SMPS используется формула (99-SMPS_Volume)

----------------
Описание трекера
----------------

Расширенный трекер работает по такому же принципу, как и стандартный трекер SMPS, однако внутренне, сильно отличается от него и обладает более сложными системами рассчета нот и их частот, а также другой системой громкостей.

Трекер поддерживает портаменто, которое программируется не флагами, а самими нотами (трекер будет рассчитывать переходы между ними). Поддерживается 4 режима портаменто.
Все переходы частот при портаменто рассчитываются не линейно, а по экспонетациальным законам, в результате чего все переходы реализуются максимально точно. Для этого в трекере применен специальный формат нот с дробной частью, а переходы частот рассчитываются по множеству заранее определенных таблиц.

Замечу, что раскладка нот из-за введения новых таблиц частот сдвинута на один тон вниз относительно оригинальной раскладки SMPS. Для точного переноса песен из оригинального формата необходимо в смещении ноты FM канала задать -1 ($FF).

-----------------------
Новые флаги координации
-----------------------

Когда включена надстройка, становятся доступсными новые флаги координации, которые не работают в противном случае. Замечу также, из-за введения новой системы расчета смещений нот и громкостей заменяются также и некоторые стандартные связанные с этим флаги SMPS.


Флаг E1:	Задать смещение ноты по частоте
Формат:		dc.b $E1, (нота<<5)+(дробная_часть)

В отличие от стандартного флага SMPS, который задает абсолютное смещение в формате частоты YM, этот флаг задает смещение в дробном внутреннем формате нот расширенного трекера.
Как видно из формата, на дробную часть отводится 5 бит, т.е. она может принимать значения 0..1F. Нота может принимать как положительные, так и отрицательные значения в пределах -4..3.
Например, значение (1<<5)+16 = $20+$10 = $30 задает смещение частоты на 1,5 ноты.

---------------------------------------------------------------------------
Флаг E6:	Изменить ослабление громкости канала
Формат:		dc.b $E6, $dd
		dc.b $E6, $00 ; сбросить ослабление громкости

Флаг прибавляет значение $dd, которое может быть как положительным, так отрицательным, к текущему ослаблению громкости канала.
Флаг работает аналогично исходному флагу SMPS, за несколькими исключениями:
1) Значение $00 сбрасывает ослабление громкости, и возвращается к первоначальному уровню громкости.
2) Если задана скорость изменения громкости (флаг $EC), флаг активизирует эффект затухания или нарастания громкости. (ВНИМАНИЕ! В настоящий момент этот эффект работает неправильно и может привести к переполнению громкости, использовать не рекомендуется.)


---------------------------------------------------------------------------
Флаг E9:	Изменить смещение ноты
Формат:		dc.b $E9, $dd
		dc.b $E6, $00 ; сбросить смещение ноты

Флаг прибавляет значение $dd, которое может быть как положительным, так отрицательным, к текущему смещению ноты.
Флаг работает аналогично исходному флагу SMPS, за одним исключением:
1) Значение $00 сбрасывает смещение ноты.


---------------------------------------------------------------------------
Флаг EC:	Задать скорость изменения громкости
Формат:		dc.b $EC, $xx

Задает скорость изменения громкости для эффекта затухания или нарастания громкости.
ВНИМАНИЕ! В настоящий момент этот эффект работает неправильно и может привести к переполнению громкости, использовать не рекомендуется.


---------------------------------------------------------------------------
Флаг FA:	Задать режим портаменто
Формат:		dc.b $FA, m

Задает режим портаменто для расширеного трекера. Выбранный режим будет работать, как только будет задана скорость портмането (см. следующий флаг). Для отключения портаменто достаточно сбросить скорость портаменто.
m может принимать следующие значения, соотвествующие выбранному режиму:

Режим 0: Постоянное портаменто.
Каждая новая нота воспринимается как "цель" для портаменто, т.е. после прочтения этой ноты трекер начнет с заданной скоростью изменять текущую частоту, пока она не достигнет конечной.

Режим 1: Портаметно работает для последовательно записанных нот.
Портаменто работает, если ноты записаны последовательно, т.е. между ними нет команды $80, которая приводит к отпусканию клавиши инструмента (key off), например:
dc.b	$A4, $80, $A6, $A8
Между нотами $24 и $26 портаменто не будет, однако как трекер прочитает ноту $28, он начнет к ней стремится с заданной скоростью от ноты $26.

Режим 2: Портаменто тянет любые ноты вниз после события "key off".
Используется для ударных и заставляет их звучать более естественно. Когда ударная начинает затухать, модулируется падение ее частоты.

Режим 3: Портаменто тянет любые ноты вверх после события "key off".


---------------------------------------------------------------------------
Флаг FB:	Задать скорость портаменто
Формат:		dc.b $FB, $xx

Задает скорость портаменто. Нулевая скорость отключается портаменто.
